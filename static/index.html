<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Wave Generator</title>
		<style>
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				font-family: "Arial", sans-serif;
				min-height: 100vh;
				background: #f0f8ff;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 20px;
			}

			h1 {
				color: #2c3e50;
				margin: 1rem 0;
				font-size: 2rem;
				text-align: center;
			}

			.upload-btn {
				background: #3498db;
				color: white;
				padding: 12px 24px;
				border-radius: 25px;
				cursor: pointer;
				border: none;
				margin: 15px 0;
				transition: background 0.3s ease;
			}

			.upload-btn:hover {
				background: #2980b9;
			}

			#imageInput {
				display: none;
			}

			.container {
				position: relative;
				margin: 20px 0;
				display: inline-block;
				max-width: 100%;
			}

			.image-wrapper {
				position: relative;
				display: inline-block;
			}

			#uploadedImage {
				display: none; /* Oculta la imagen por defecto */
				max-width: 100%;
				height: auto;
				position: relative;
				z-index: 1;
			}
			#uploadedImage.show {
				display: block;
			}
			.svg-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				pointer-events: none;
				z-index: 2;
			}
			.svg-overlay svg {
				width: 100%;
				height: 100%;
			}
			.loading {
				display: none;
				color: #3498db;
				margin-top: 10px;
				font-weight: bold;
			}

			#segmentsTable {
				margin: 30px auto 0 auto;
				border-collapse: collapse;
				width: 100%;
				max-width: 900px;
				background: #fff;
				box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
				border-radius: 8px;
				overflow: hidden;
				display: none;
			}
			#segmentsTable th,
			#segmentsTable td {
				padding: 10px 16px;
				text-align: center;
			}
			#segmentsTable th {
				background: #3498db;
				color: #fff;
				font-weight: bold;
			}
			#segmentsTable tr:nth-child(even) {
				background: #f4f8fb;
			}
			#segmentsTable tr:hover {
				background: #eaf3fa;
			}
			#errorMsg {
				display: none;
				color: #c0392b;
				background: #fdecea;
				border: 1px solid #e74c3c;
				padding: 12px 20px;
				margin: 20px auto 0 auto;
				border-radius: 6px;
				max-width: 600px;
				text-align: center;
				font-weight: bold;
			}
		</style>
		<style type="text/css" id="operaUserStyle"></style>
		<style type="text/css"></style>
	</head>
	<body>
		<h1>Wave Generator</h1>
		<div style="margin-bottom: 1.5rem">
			<a
				href="/blog/wave-generator-math-tutorial"
				target="_blank"
				style="color: #3498db; font-weight: bold; text-decoration: underline"
			>
				Read the Math & Programming Tutorial
			</a>
		</div>

		<label class="upload-btn" for="imageInput"> ðŸ“· Upload Image </label>
		<input type="file" id="imageInput" accept="image/*" />

		<div class="container">
			<div class="image-wrapper">
				<img
					id="uploadedImage"
					alt="Uploaded image"
					src="blob:http://localhost:8899/a75cebef-ff0a-4bf3-a56f-de8f2aea9fea"
				/>
				<div class="svg-overlay" id="svgContainer" style="width: 284px; height: 177px"></div>
			</div>
		</div>

		<table id="segmentsTable">
			<thead>
				<tr>
					<th>#</th>
					<th>Domain Start</th>
					<th>Domain End</th>
					<th>Expression</th>
					<th>Mini SVG</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>

		<div class="loading" id="loading" style="display: none">Processing...</div>
		<div id="errorMsg" style="display: none"></div>
		<script>
			const input = document.getElementById("imageInput")
			const imageWrapper = document.querySelector(".image-wrapper")
			const uploadedImage = document.getElementById("uploadedImage")
			const svgContainer = document.getElementById("svgContainer")
			const loading = document.getElementById("loading")
			const errorMsg = document.getElementById("errorMsg")
			const segmentsTableEl = document.getElementById("segmentsTable")
			const segmentsTableBody = segmentsTableEl.querySelector("tbody")

			input.addEventListener("change", async (e) => {
				const file = e.target.files[0]
				if (!file) return

				// Reset previous elements
				svgContainer.innerHTML = ""
				uploadedImage.classList.remove("show")
				segmentsTableEl.style.display = "none"
				segmentsTableBody.innerHTML = ""
				errorMsg.style.display = "none"
				errorMsg.textContent = ""
				loading.style.display = "block"

				// Redimensiona la imagen antes de enviarla al servidor (mÃ¡x 1280x720)
				function resizeImageFile(file, maxWidth = 1280, maxHeight = 720) {
					return new Promise((resolve, reject) => {
						const img = new Image()
						img.onload = () => {
							let width = img.naturalWidth
							let height = img.naturalHeight
							let scale = Math.min(maxWidth / width, maxHeight / height, 1)
							if (scale < 1) {
								width = Math.round(width * scale)
								height = Math.round(height * scale)
							}
							const canvas = document.createElement("canvas")
							canvas.width = width
							canvas.height = height
							const ctx = canvas.getContext("2d")
							ctx.drawImage(img, 0, 0, width, height)
							canvas.toBlob((blob) => {
								if (blob) resolve({ blob, width, height })
								else reject(new Error("No se pudo redimensionar la imagen"))
							}, file.type)
						}
						img.onerror = reject
						const reader = new FileReader()
						reader.onload = (e) => {
							img.src = e.target.result
						}
						reader.onerror = reject
						reader.readAsDataURL(file)
					})
				}

				try {
					// Redimensionar la imagen antes de mostrarla y enviarla
					const { blob: resizedBlob, width: imgW, height: imgH } = await resizeImageFile(file, 1280, 720)
					const resizedUrl = URL.createObjectURL(resizedBlob)
					uploadedImage.src = resizedUrl

					// Esperar a que la imagen estÃ© cargada antes de mostrarla y procesar el SVG
					await new Promise((resolve) => {
						uploadedImage.onload = () => {
							imageWrapper.style.width = `${imgW}px`
							imageWrapper.style.height = `${imgH}px`
							uploadedImage.classList.add("show")
							resolve()
						}
					})

					// Enviar la imagen redimensionada al backend
					const imageBytes = await resizedBlob.arrayBuffer()
					const res = await fetch("/generate-wave", {
						method: "POST",
						headers: { "Content-Type": file.type },
						body: imageBytes,
					})

					if (!res.ok) {
						const errText = await res.text()
						throw new Error(errText || "Server error")
					}

					const { svg, segments } = await res.json()
					svgContainer.innerHTML = svg

					// Ajustar SVG al tamaÃ±o de la imagen mostrada y superponerlo
					const svgElement = svgContainer.querySelector("svg")
					if (svgElement) {
						svgElement.removeAttribute("viewBox")
						svgElement.setAttribute("width", imgW)
						svgElement.setAttribute("height", imgH)
					}
					svgContainer.style.width = `${imgW}px`
					svgContainer.style.height = `${imgH}px`

					// Render segments table
					if (segments && Array.isArray(segments) && segments.length > 0) {
						segmentsTableBody.innerHTML = segments
							.map(
								(seg, idx) => `
						<tr>
							<td>${idx + 1}</td>
							<td>${seg.domain_start ?? seg.X0 ?? ""}</td>
							<td>${seg.domain_end ?? seg.X1 ?? ""}</td>
							<td style="font-family:monospace">${seg.expression ?? seg.Expression ?? ""}</td>
							<td>${seg.svg ?? ""}</td>
						</tr>
					`
							)
							.join("")
						segmentsTableEl.style.display = "table"
					}
				} catch (error) {
					console.error("Error:", error)
					errorMsg.textContent = "Error: " + (error?.message || error)
					errorMsg.style.display = "block"
				} finally {
					loading.style.display = "none"
				}
			})
		</script>
	</body>
</html>
